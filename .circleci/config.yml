version: 2.1

orbs:
  cypress: cypress-io/cypress@1

jobs:
  unit-tests:
    machine:
      image: ubuntu-2204:2022.07.1
      docker_layer_caching: true
    resource_class: medium
    steps:
      - checkout
      - run: cd packages/frontend && yarn && yarn test:coverage
  
  e2e-tests:
    machine:
      image: ubuntu-2204:2022.07.1
      docker_layer_caching: true
    resource_class: medium
    steps:
      - checkout
      - run: sudo apt update
      - run: sudo apt-get install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
      - run: sudo apt install -y docker-compose
      - run: docker-compose -f packages/backend/docker-compose.yml up -d
      # - run: yarn global add cypress@10.7.0
      - run: cd packages/frontend && yarn && yarn dev &
      - run: ls -lah && cp -R node_modules packages/frontend/node_modules
      - run: cd packages/frontend/ && yarn cypress run

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  build:
    jobs:
      - cypress/run:
          yarn: true
          executor: cypress/base-14
          working_directory: packages/frontend
  orb-free-workflow:
    jobs:
      - unit-tests
      # - e2e-tests
